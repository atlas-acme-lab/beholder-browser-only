!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("pixi.js")):"function"==typeof define&&define.amd?define(["pixi.js"],t):"object"==typeof exports?exports["beholder-detection"]=t(require("pixi.js")):e["beholder-detection"]=t(e.PIXI)}(window,(function(e){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(t,r){t.exports=e},function(e,t,r){"use strict";r.r(t),r.d(t,"init",(function(){return D})),r.d(t,"show",(function(){return S})),r.d(t,"hide",(function(){return T})),r.d(t,"getMarkers",(function(){return R})),r.d(t,"getMarker",(function(){return k})),r.d(t,"update",(function(){return I}));var n=r(0),o=o||{};o.Image=function(e,t,r){this.width=e||0,this.height=t||0,this.data=r||[]},o.threshold=function(e,t,r){var n,o=e.data,i=t.data,a=o.length,d=[];for(n=0;n<256;++n)d[n]=n<=r?0:255;for(n=0;n<a;++n)i[n]=d[o[n]];return t.width=e.width,t.height=e.height,t},o.otsu=function(e){var t,r,n,o=e.data,i=o.length,a=[],d=0,s=0,u=0,l=0,h=0,c=0;for(n=0;n<256;++n)a[n]=0;for(n=0;n<i;++n)a[o[n]]++;for(n=0;n<256;++n)s+=a[n]*n;for(n=0;n<256;++n)if(0!==(l+=a[n])){if(0===(h=i-l))break;(r=l*h*(t=(u+=a[n]*n)/l-(s-u)/h)*t)>c&&(c=r,d=n)}return d},o.gaussianBlur=function(e,t,r,n){var i=o.gaussianKernel(n);return t.width=e.width,t.height=e.height,r.width=e.width,r.height=e.height,o.gaussianBlurFilter(e,r,i,!0),o.gaussianBlurFilter(r,t,i,!1),t},o.findContours=function(e,t){var r,n,i,a,d,s,u,l,h,c=e.width,f=e.height,x=[];for(r=o.binaryBorder(e,t),n=o.neighborhoodDeltas(c+2),i=c+3,d=1,l=0;l<f;++l,i+=2)for(h=0;h<c;++h,++i)0!==(a=r[i])&&(s=u=!1,1===a&&0===r[i-1]?s=!0:a>=1&&0===r[i+1]&&(u=!0),(s||u)&&(++d,x.push(o.borderFollowing(r,i,d,{x:h,y:l},u,n))));return x},o.borderFollowing=function(e,t,r,n,i,a){var d,s,u,l,h,c=[];c.hole=i,l=h=i?0:4;do{if(0!==e[d=t+a[l=l-1&7]])break}while(l!==h);if(l===h)e[t]=-r,c.push({x:n.x,y:n.y});else for(s=t,4^l;;){h=l;do{u=s+a[++l]}while(0===e[u]);if((l&=7)-1>>>0<h>>>0?e[s]=-r:1===e[s]&&(e[s]=r),c.push({x:n.x,y:n.y}),l,n.x+=o.neighborhood[l][0],n.y+=o.neighborhood[l][1],u===t&&s===d)break;s=u,l=l+4&7}return c},o.neighborhood=[[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1]],o.neighborhoodDeltas=function(e){for(var t=[],r=o.neighborhood.length,n=0;n<r;++n)t[n]=o.neighborhood[n][0]+o.neighborhood[n][1]*e;return t.concat(t)},o.approxPolyDP=function(e,t){var r,n,o,i,a,d,s,u,l,h,c,f={start_index:0,end_index:0},x={start_index:0,end_index:0},p=[],y=[],g=e.length;for(t*=t,c=0,l=0;l<3;++l)for(a=0,n=e[c=(c+x.start_index)%g],++c===g&&(c=0),h=1;h<g;++h)r=e[c],++c===g&&(c=0),(i=(s=r.x-n.x)*s+(u=r.y-n.y)*u)>a&&(a=i,x.start_index=h);for(a<=t?p.push({x:n.x,y:n.y}):(f.start_index=c,f.end_index=x.start_index+=f.start_index,x.start_index-=x.start_index>=g?g:0,x.end_index=f.start_index,x.end_index<x.start_index&&(x.end_index+=g),y.push({start_index:x.start_index,end_index:x.end_index}),y.push({start_index:f.start_index,end_index:f.end_index}));0!==y.length;){if(o=e[(f=y.pop()).end_index%g],n=e[c=f.start_index%g],++c===g&&(c=0),f.end_index<=f.start_index+1)d=!0;else{for(a=0,s=o.x-n.x,u=o.y-n.y,l=f.start_index+1;l<f.end_index;++l)r=e[c],++c===g&&(c=0),(i=Math.abs((r.y-n.y)*s-(r.x-n.x)*u))>a&&(a=i,x.start_index=l);d=a*a<=t*(s*s+u*u)}d?p.push({x:n.x,y:n.y}):(x.end_index=f.end_index,f.end_index=x.start_index,y.push({start_index:x.start_index,end_index:x.end_index}),y.push({start_index:f.start_index,end_index:f.end_index}))}return p},o.warp=function(e,t,r,n){var i,a,d,s,u,l,h,c,f,x,p,y,g,v,b,m,w,_,M,E,D,C,S=e.data,T=t.data,P=e.width,O=e.height,j=0;for(g=(y=o.getPerspectiveTransform(r,n-1))[8],v=y[2],b=y[5],D=0;D<n;++D)for(m=g+=y[7],w=v+=y[1],_=b+=y[4],C=0;C<n;++C)m+=y[6],a=(i=(M=(w+=y[0])/m)>>>0)===P-1?i:i+1,s=1-(d=M-i),h=1-(l=(E=(_+=y[3])/m)-(u=E>>>0)),c=f=u*P,x=p=(u===O-1?u:u+1)*P,T[j++]=h*(s*S[c+i]+d*S[f+a])+l*(s*S[x+i]+d*S[p+a])&255;return t.width=n,t.height=n,t},o.getPerspectiveTransform=function(e,t){var r=o.square2quad(e);return r[0]/=t,r[1]/=t,r[3]/=t,r[4]/=t,r[6]/=t,r[7]/=t,r},o.square2quad=function(e){var t,r,n,o,i,a,d,s=[];return t=e[0].x-e[1].x+e[2].x-e[3].x,r=e[0].y-e[1].y+e[2].y-e[3].y,0===t&&0===r?(s[0]=e[1].x-e[0].x,s[1]=e[2].x-e[1].x,s[2]=e[0].x,s[3]=e[1].y-e[0].y,s[4]=e[2].y-e[1].y,s[5]=e[0].y,s[6]=0,s[7]=0,s[8]=1):(n=e[1].x-e[2].x,o=e[3].x-e[2].x,i=e[1].y-e[2].y,d=n*(a=e[3].y-e[2].y)-o*i,s[6]=(t*a-o*r)/d,s[7]=(n*r-t*i)/d,s[8]=1,s[0]=e[1].x-e[0].x+s[6]*e[1].x,s[1]=e[3].x-e[0].x+s[7]*e[3].x,s[2]=e[0].x,s[3]=e[1].y-e[0].y+s[6]*e[1].y,s[4]=e[3].y-e[0].y+s[7]*e[3].y,s[5]=e[0].y),s},o.isContourConvex=function(e){var t,r,n,o,i,a,d,s,u=0,l=!0,h=e.length,c=0,f=0;for(r=e[h-1],i=(t=e[0]).x-r.x,a=t.y-r.y;c<h;++c){if(++f===h&&(f=0),r=t,d=(t=e[f]).x-r.x,3===(u|=(o=(s=t.y-r.y)*i)>(n=d*a)?1:o<n?2:3)){l=!1;break}i=d,a=s}return l},o.perimeter=function(e){for(var t,r,n=e.length,o=0,i=n-1,a=0;o<n;i=o++)t=e[o].x-e[i].x,r=e[o].y-e[i].y,a+=Math.sqrt(t*t+r*r);return a},o.minEdgeLength=function(e){for(var t,r,n,o=e.length,i=0,a=o-1,d=1/0;i<o;a=i++)(t=(r=e[i].x-e[a].x)*r+(n=e[i].y-e[a].y)*n)<d&&(d=t);return Math.sqrt(d)},o.countNonZero=function(e,t){var r,n,o=e.data,i=t.height,a=t.width,d=t.x+t.y*e.width,s=e.width-a,u=0;for(r=0;r<i;++r){for(n=0;n<a;++n)0!==o[d++]&&++u;d+=s}return u},o.binaryBorder=function(e,t){var r,n,o=e.data,i=e.height,a=e.width,d=0,s=0;for(n=-2;n<a;++n)t[s++]=0;for(r=0;r<i;++r){for(t[s++]=0,n=0;n<a;++n)t[s++]=0===o[d++]?0:1;t[s++]=0}for(n=-2;n<a;++n)t[s++]=0;return t};var i=o;function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const u={};let l={MIN_MARKER_DISTANCE:10,MIN_MARKER_PERIMETER:.2,MAX_MARKER_PERIMETER:.8,SIZE_AFTER_PERSPECTIVE_REMOVAL:49};u.setCameraParams=e=>{l=d(d({},l),e)},u.Marker=(e,t)=>{const r=(t[0].y-t[2].y)/(t[0].x-t[2].x),n=(t[1].y-t[3].y)/(t[1].x-t[3].x),o={x:0,y:0};var i,a,d;return o.x=function(e,t,r,n){return(r.y-n.y+t*n.x-e*r.x)/(t-e)}(r,n,t[0],t[1]),o.y=(i=t[0],a=r,d=o.x,a*(d-i.x)+i.y),{id:e,corners:t,center:o}},u.Detector=function(){this.grey=new i.Image,this.thres=new i.Image,this.homography=new i.Image,this.binary=[],this.contours=[],this.polys=[],this.candidates=[]},u.Detector.prototype.detect=function(e,t){return this.contours=i.findContours(e,this.binary),this.candidates=this.findCandidates(this.contours,e.width*l.MIN_MARKER_PERIMETER,e.width*l.MAX_MARKER_PERIMETER,.05,10),this.candidates=this.clockwiseCorners(this.candidates),this.candidates=this.notTooNear(this.candidates,l.MIN_MARKER_DISTANCE),this.findMarkers(t,this.candidates,l.SIZE_AFTER_PERSPECTIVE_REMOVAL)},u.Detector.prototype.findCandidates=function(e,t,r,n,o){var a,d,s,u=[],l=e.length;for(this.polys=[],s=0;s<l;++s)(a=e[s]).length>=t&&a.length<=r&&(d=i.approxPolyDP(a,a.length*n),this.polys.push(d),4===d.length&&i.isContourConvex(d)&&i.minEdgeLength(d)>=o&&u.push(d));return u},u.Detector.prototype.clockwiseCorners=function(e){var t,r,n,o,i,a=e.length;for(i=0;i<a;++i)t=e[i][1].x-e[i][0].x,n=e[i][1].y-e[i][0].y,r=e[i][2].x-e[i][0].x,t*(e[i][2].y-e[i][0].y)-n*r<0&&(o=e[i][1],e[i][1]=e[i][3],e[i][3]=o);return e},u.Detector.prototype.notTooNear=function(e,t){var r,n,o,a,d,s,u=[],l=e.length;for(a=0;a<l;++a)for(d=a+1;d<l;++d){for(r=0,s=0;s<4;++s)r+=(n=e[a][s].x-e[d][s].x)*n+(o=e[a][s].y-e[d][s].y)*o;r/4<t*t&&(i.perimeter(e[a])<i.perimeter(e[d])?e[a].tooNear=!0:e[d].tooNear=!0)}for(a=0;a<l;++a)e[a].tooNear||u.push(e[a]);return u},u.Detector.prototype.findMarkers=function(e,t,r){var n,o,a,d=[],s=t.length;for(a=0;a<s;++a)n=t[a],i.warp(e,this.homography,n,r),i.threshold(this.homography,this.homography,i.otsu(this.homography)),(o=this.getMarker(this.homography,n))&&d.push(o);return d},u.Detector.prototype.getMarker=function(e,t){var r,n,o,a,d,s=e.width/7>>>0,l=s*s>>1,h=[],c=[],f=[];for(a=0;a<7;++a)for(o=0===a||6===a?1:6,d=0;d<7;d+=o)if(r={x:d*s,y:a*s,width:s,height:s},i.countNonZero(e,r)>l)return null;for(a=0;a<5;++a)for(h[a]=[],d=0;d<5;++d)r={x:(d+1)*s,y:(a+1)*s,width:s,height:s},h[a][d]=i.countNonZero(e,r)>l?1:0;for(c[0]=h,f[0]=this.hammingDistance(c[0]),n={first:f[0],second:0},a=1;a<4;++a)c[a]=this.rotate(c[a-1]),f[a]=this.hammingDistance(c[a]),f[a]<n.first&&(n.first=f[a],n.second=a);return 0!==n.first?null:u.Marker(this.mat2id(c[n.second]),this.rotate2(t,4-n.second))},u.Detector.prototype.hammingDistance=function(e){var t,r,n,o,i,a=[[1,0,0,0,0],[1,0,1,1,1],[0,1,0,0,1],[0,1,1,1,0]],d=0;for(n=0;n<5;++n){for(r=1/0,o=0;o<4;++o){for(t=0,i=0;i<5;++i)t+=e[n][i]===a[o][i]?0:1;t<r&&(r=t)}d+=r}return d},u.Detector.prototype.mat2id=function(e){var t,r=0;for(t=0;t<5;++t)r<<=1,r|=e[t][1],r<<=1,r|=e[t][3];return r},u.Detector.prototype.rotate=function(e){var t,r,n=[],o=e.length;for(t=0;t<o;++t)for(n[t]=[],r=0;r<e[t].length;++r)n[t][r]=e[e[t].length-r-1][t];return n},u.Detector.prototype.rotate2=function(e,t){var r,n=[],o=e.length;for(r=0;r<o;++r)n[r]=e[(t+r)%o];return n};var h=u;var c=class{constructor(e,t){this.width=e,this.height=t,this.size=e*t,this.data=[],this.data.length=this.size}sampleFrom(e,t,r,n){for(let n=0;n<this.height;n++){for(let o=0;o<this.width;o++){let i=o+r;this.data[n*this.width+o]=e[4*(n*t+i)]}}}};new n.Filter("","\n  varying vec2 vTextureCoord;\n  uniform sampler2D uSampler;\n  void main(void)\n  {\n    // vec4 color = texture2D(uSampler, vTextureCoord);\n    // float thres = color.r > 0.6 ? 1.0 : 0.0;\n    // gl_FragColor = vec4(thres, thres, thres, 1.0);\n  }\n",{});const f=new n.Filter("","\n    varying vec2 vTextureCoord;\n    uniform sampler2D uSampler;\n    void main(void)\n    {\n      vec4 color = texture2D(uSampler, vTextureCoord);\n      float gray = dot(color.rgb, vec3(0.299, 0.587, 0.114));\n      gl_FragColor = vec4(vec3(gray), 1.0);\n    }\n  ",{}),x=new n.Filter("","\n  varying vec2 vTextureCoord;\n  uniform sampler2D uSampler;  // Texture that will be blurred by this shader\n\n  uniform float blurSize;\n\n  void main() {\n    float blurDiv = (blurSize * 2.0 + 1.0) * (blurSize * 2.0 + 1.0);\n    float pixelX = 1.0 / 480.0;\n    float pixelY = 1.0 / 360.0;\n    float source = texture2D(uSampler, vTextureCoord).r;\n    float blurredVal = 0.0;\n\n    for (float x = 0.0; x <= 1000.0; x++) {\n      if (x > blurSize + blurSize) break;\n      float xCoord = x - blurSize;\n\n      for (float y = 0.0; y <= 1000.0; y++) {\n        if (y > blurSize + blurSize) break;\n\n        float yCoord = y - blurSize;\n        float neighbor = texture2D(uSampler, vec2(vTextureCoord.x + (pixelX * xCoord), vTextureCoord.y + (pixelY * yCoord))).r;\n        blurredVal += neighbor;\n      }\n    }\n\n    blurredVal = blurredVal / blurDiv;  \n    blurredVal = (source - blurredVal < -0.035) ? 1.0 : 0.0;\n    // blurredVal = texture2D(uSampler, vec2(vTextureCoord.x + (pixelX * 30.0), vTextureCoord.y + (pixelY * 30.0))).r;\n\n    gl_FragColor = vec4(blurredVal, blurredVal, blurredVal, 1.0);\n  }",{blurSize:2});let p,y,g,v,b,m,w,_=!1;let M,E;const D=()=>{v=document.createElement("div"),v.id="beholder-container",v.style="\n    position: absolute;\n    margin: 0;\n    padding: 0;\n    left: 0;\n    top: 0;\n    width: 100vw;\n    z-index: 10;\n    display: none;\n  ",document.body.appendChild(v),p=document.createElement("video"),p.autoplay="true",p.style="display:none;",v.appendChild(p),b=document.createElement("canvas"),b.id="pixi-container",b.style="\n    position: absolute;\n    left: 0;\n    top: 0;\n  ",v.appendChild(b),void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(r,n){t.call(navigator,e,r,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))});let e="WebGL";n.utils.isWebGLSupported()||(e="canvas"),w=new n.Application({width:1280,height:480,antialias:!1,transparent:!1,resolution:1,view:b,autoStart:!1});var t=n.Texture.from(p),r=n.Texture.from(p);M=new n.Sprite(t),E=new n.Sprite(r),M.width=640,M.height=480,E.width=640,E.height=480,M.filters=[f,x],E.filters=[f],w.stage.addChild(M),M.position.x=640,w.stage.addChild(E),m=new n.Graphics,w.stage.addChild(m),navigator.mediaDevices.getUserMedia({video:{width:640,height:480,facingMode:"environment"}}).then((function(e){"srcObject"in p?p.srcObject=e:p.src=window.URL.createObjectURL(e),g=new h.Detector,_=!0})).catch((function(e){console.log(e.name+": "+e.message)}))};let C=!1;const S=()=>{C=!0,v.style="\n    position: absolute;\n    margin: 0;\n    padding: 0;\n    left: 0;\n    top: 0;\n    width: 100vw;\n    z-index: 10;\n    display: block;\n  "},T=()=>{C=!1,v.style="\n    position: absolute;\n    margin: 0;\n    padding: 0;\n    left: 0;\n    top: 0;\n    width: 100vw;\n    z-index: 10;\n    display: none;\n  "};let P=new c(640,480),O=new c(640,480),j=[];const R=()=>j,k=e=>j.find(t=>t.id===e),I=e=>{_&&(w.render(),y=w.renderer.plugins.extract.pixels(w.stage),P.sampleFrom(y,1280,640,0),O.sampleFrom(y,1280,0,0),j=g.detect(P,O),C&&(m.clear(),j.forEach(e=>{const t=e.corners;m.lineStyle(2,4474111),m.moveTo(t[0].x,t[0].y),m.lineTo(t[1].x,t[1].y),m.lineTo(t[2].x,t[2].y),m.lineTo(t[3].x,t[3].y),m.lineTo(t[0].x,t[0].y),m.endFill()})))};t.default={init:D,update:I,getMarker:k,getMarkers:R,show:S,hide:T}}])}));